<!doctype html><html lang="ko"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QR Order - 배달/예약</title>
<script src="https://js.tosspayments.com/v1"></script>
<style>body{font-family:system-ui,Segoe UI,Noto Sans KR,sans-serif;background:#0b0f14;color:#e6edf3;margin:0} .wrap{max-width:700px;margin:20px auto;padding:16px} .card{background:#0d131b;border:1px solid #223;border-radius:12px;padding:12px;margin-bottom:12px} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap} .btn{padding:10px 14px;border:1px solid #294760;border-radius:10px;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer} input,select,textarea{padding:10px;border-radius:10px;border:1px solid #223;background:#0e1520;color:#e6edf3}
/* --- Responsive square grid for menu buttons --- */
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.menu-card{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;width:100%;aspect-ratio:1/1;border-radius:12px;border:1px solid #223;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer;padding:8px}
.menu-card:hover{filter:brightness(1.06)}
.menu-title{font-weight:600;line-height:1.2;word-break:keep-all;overflow-wrap:anywhere}
.menu-price{margin-top:6px;opacity:.9;font-size:.9em}
.required{color:#f88}
</style>
</head><body><div class="wrap">
<h1>배달/예약</h1>

<div class="card" style="margin-bottom:10px">
  <div id="tabs" style="display:flex;gap:8px">
    <button class="tabBtn active" data-tab="order">주문</button>
    <button class="tabBtn" data-tab="history">이전 주문</button>
  </div>
</div>
<div id="orderPane" class="tabPane active">
<div class="card">
  <h3>배송/예약 정보 <span class="required">*</span></h3>
  <div class="row"><input id="addr" placeholder="배송지 주소 *" required/></div>
  <div class="row"><input id="name" placeholder="주문자 이름 *" required/></div>
  <div class="row"><input id="phone" placeholder="연락처 (숫자만) *" required/></div>
  <div class="row">
    <label style="width:90px">예약일자</label>
    <input type="date" id="date"/>
    <input type="time" id="time"/>
  </div>
  <div class="row"><textarea id="note" placeholder="요청사항" style="width:100%;min-height:80px"></textarea></div>
</div>
<style>
.tabBtn{padding:8px 12px;border-radius:8px;border:1px solid #335;background:#0b1a2b;color:#e6edf3;cursor:pointer}
.tabBtn.active{background:#14324a}
.tabPane{display:none}
.tabPane.active{display:block}
</style>

<div class="card">
  <h3>메뉴</h3>
  <div id="menu"></div>
</div>

<div class="card">
  <h3>장바구니 <span id="cartCountBadge" class="small"></span></h3>
  <div id="cartList"></div>
</div>

<div class="card">
  <div class="row">
    <div>합계: <b id="sum">0</b>원</div>
    <button class="btn" id="payBtn">결제하기</button>
  </div>
</div>

<script>
  const cart = loadCart();
  let menuData = [];
  let clientKey = null;
  const fmt = (n)=> (n||0).toLocaleString('ko-KR');

  function setPayEnabled(enabled){
    const btn = document.getElementById('payBtn');
    btn.disabled = !enabled;
    btn.style.opacity = enabled ? '1' : '0.5';
    btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
  }
  function updateSum(){
    let sum = 0;
    for(const [id, qty] of cart){
      const m = menuData.find(x=> x.id===id);
      if(m) sum += (Number(m.price)||0) * (Number(qty)||0);
    }
    document.getElementById('sum').textContent = fmt(sum);
    setPayEnabled(sum>0 && cart.size>0);
    return sum;
  }
  
  // --- Cart Persistence & Rendering ---
  function loadCart() {
    try {
      const raw = localStorage.getItem('qrCart');
      if (!raw) return new Map();
      const arr = JSON.parse(raw);
      const m = new Map(arr.filter(([_,q]) => Number(q) > 0));
      return m;
    } catch (_) { return new Map(); }
  }
  function saveCart() {
    try {
      const arr = Array.from(cart.entries()).filter(([_,q]) => Number(q) > 0);
      localStorage.setItem('qrCart', JSON.stringify(arr));
    } catch (_) {}
  }
  function updateCartBadge(){
    const cnt = Array.from(cart.values()).reduce((a,b)=>a+Number(b||0),0);
    const el = document.getElementById('cartCountBadge');
    if (!el) return;
    el.textContent = cnt ? `(${cnt}개 담김)` : '';
  }
  function renderCart() {
    const box = document.getElementById('cartList');
    if (!box) return;
    if (cart.size === 0) {
      box.innerHTML = '<div class="small">담긴 항목이 없습니다 메뉴를 눌러 추가해주세요</div>';
      updateCartBadge();
      return;
    }
    const rows = [];
    for (const [id, qty] of cart) {
      const m = menuData.find(x=>x.id===id);
      if (!m) continue;
      const price = Number(m.price)||0;
      const line = price * (Number(qty)||0);
      rows.push(`
        <div class="row" style="margin:6px 0; justify-content: space-between;">
          <div style="min-width:140px">${m.name} <span class="small">x ${qty}</span></div>
          <div style="min-width:80px">${fmt(line)}원</div>
          <div class="row" style="gap:6px">
            <button class="btn" onclick="subItem('${m.id}')">-</button>
            <button class="btn" onclick="addItem('${m.id}')">+</button>
          </div>
        </div>
      `);
    }
    box.innerHTML = rows.join('');
    updateCartBadge();
  }

  function renderMenu(){
    const box = document.getElementById('menu');
    box.classList.add('menu-grid');
    box.innerHTML = menuData.map(m=>`
      <button class="menu-card" onclick="addItem('${m.id}')">
        <div class="menu-title">${m.name}</div>
        <div class="menu-price">${fmt(m.price)}원</div>
      </button>
    `).join('');
  }

  function addItem(id){ cart.set(id,(cart.get(id)||0)+1); saveCart(); renderMenu(); renderCart(); updateSum(); }
  function subItem(id){ const v=(cart.get(id)||0)-1; if(v<=0) cart.delete(id); else cart.set(id,v); saveCart(); renderMenu(); renderCart(); updateSum(); }
  async function loadMenu(){ const r=await fetch('/menu'); menuData=await r.json(); renderMenu(); updateSum(); }
  async function loadClientKey(){ const r=await fetch('/config'); const j=await r.json(); clientKey=j.clientKey; }
  function getAmount(){ return Number(document.getElementById('sum').textContent.replace(/[^0-9]/g,''))||0; }

  function makeOrderId(){ return 'ORD-'+Math.random().toString(36).slice(2,10)+'-'+Date.now(); }

  // ===== 배달 정보 수집 및 검증 =====
  function getDeliveryInfo() {
    const addr = (document.getElementById('addr').value||'').trim();
    const name = (document.getElementById('name').value||'').trim();
    const phone = (document.getElementById('phone').value||'').trim();
    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;
    const note = (document.getElementById('note').value||'').trim();

    // 필수 필드 검증
    if (!addr) {
      alert('배송지 주소를 입력해주세요.');
      document.getElementById('addr').focus();
      return null;
    }
    if (!name) {
      alert('주문자 이름을 입력해주세요.');
      document.getElementById('name').focus();
      return null;
    }
    if (!phone) {
      alert('연락처를 입력해주세요.');
      document.getElementById('phone').focus();
      return null;
    }

    // 전화번호 형식 검증 (숫자만)
    const phoneClean = phone.replace(/[^0-9]/g, '');
    if (phoneClean.length < 10) {
      alert('올바른 연락처를 입력해주세요 (10자리 이상)');
      document.getElementById('phone').focus();
      return null;
    }

    // 예약 시간 조합
    let reserveTime = '';
    if (date && time) {
      reserveTime = `${date} ${time}`;
    } else if (date) {
      reserveTime = date;
    }

    return {
      addr,
      name,
      phone: phoneClean,
      reserveTime,
      note
    };
  }

  async function requestPay(){
    const amount = getAmount();
    
    // 장바구니 검증
    if(cart.size===0 || amount<=0){ 
      alert('메뉴를 담아 주세요'); 
      return; 
    }

    // 배달 정보 수집 및 검증
    const deliveryInfo = getDeliveryInfo();
    if (!deliveryInfo) {
      return; // 검증 실패 시 중단
    }

    if(!clientKey){ await loadClientKey(); }
    if(!window.TossPayments || !clientKey){ 
      alert('결제 모듈 초기화 실패'); 
      return; 
    }

    const orderId = makeOrderId();
    const orderName = '배달/예약 주문';
    const origin = window.location.origin;
    const successUrl = `${origin}/payment/success`;
    const failUrl = `${origin}/payment/fail`;
    const items = Array.from(cart.entries()).map(([id,qty])=>[id,qty]);

    // sessionStorage에 배달 정보 포함하여 저장
    sessionStorage.setItem('qrOrderPending', JSON.stringify({ 
      items, 
      amount, 
      orderId,
      deliveryInfo,
      orderType: 'delivery'
    }));

    try{
      const tossPayments = TossPayments(clientKey);
      await tossPayments.requestPayment('카드',{ 
        amount, 
        orderId, 
        orderName, 
        successUrl, 
        failUrl,
        customerName: deliveryInfo.name,
        customerMobilePhone: deliveryInfo.phone
      });
    }catch(e){
      const code = e && (e.code || e.name);
      const ignorable = ['USER_CANCEL', 'PAY_PROCESS_CANCELED', 'POPUP_CLOSED'];
      if (ignorable.includes(code)) { 
        return; 
      }
      console.error('[TossPayments error]', e);
      const reason = encodeURIComponent(code || 'UNKNOWN');
      window.location.href = `/payment/fail?reason=${reason}`;
    }
  }

  document.getElementById('payBtn').onclick = requestPay;
  setPayEnabled(false); 
  loadClientKey(); 
  loadMenu();
  renderCart(); 
  updateCartBadge();
</script>
</div>
<div id="historyPane" class="tabPane" style="display:none">
  <div class="card">
    <h3>이전 주문</h3>
    <div id="history"></div>
    <div class="small">이 브라우저에서 진행된 최근 주문을 표시합니다.</div>
  </div>
</div>

<script>
function renderHistoryInto(elId){
  var box=document.getElementById(elId);
  if(!box) return;
  try{
    var arr=JSON.parse(localStorage.getItem('qrOrderHistory')||'[]');
    if(!arr.length){ 
      box.innerHTML='<div class="small">표시할 내역이 없습니다.</div>'; 
      return; 
    }
    box.innerHTML = arr.slice(-50).reverse().map(function(o){
      var d=new Date(o.time||Date.now());
      var m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
      var hh=('0'+d.getHours()).slice(-2), mi=('0'+d.getMinutes()).slice(-2);
      var items=(o.items||[]).map(function(p){ return p[0]+'×'+p[1]; }).join(', ');
      var extra=[o.addr?(' · '+o.addr):'', o.reserve?(' · '+o.reserve):''].join('');
      var amt=o.amount||0;
      return '<div style="padding:6px 0;border-bottom:1px solid #223">'+m+'/'+dd+' '+hh+':'+mi+' · '+items+extra+(amt?(' · 합계 '+amt.toLocaleString('ko-KR')+'원'):'')+'</div>';
    }).join('');
  }catch(e){ box.innerHTML=''; }
}

document.addEventListener('DOMContentLoaded', function(){
  var tabs=document.querySelectorAll('.tabBtn');
  var orderPane=document.getElementById('orderPane');
  var historyPane=document.getElementById('historyPane');
  function activate(which){
    tabs.forEach(function(b){ b.classList.toggle('active', b.dataset.tab===which); });
    if(orderPane) orderPane.style.display = (which==='order') ? 'block' : 'none';
    if(historyPane){
      historyPane.style.display = (which==='history') ? 'block' : 'none';
      if(which==='history') renderHistoryInto('history');
    }
  }
  activate('order');
  tabs.forEach(function(b){ b.addEventListener('click', function(){ activate(b.dataset.tab); }); });
});
</script>
</div></body></html>