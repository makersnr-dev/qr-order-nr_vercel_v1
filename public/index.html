<!doctype html><html lang="ko"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QR Order - 주문</title>
<script src="https://js.tosspayments.com/v1"></script>
<style>body{font-family:system-ui,Segoe UI,Noto Sans KR,sans-serif;background:#0b0f14;color:#e6edf3;margin:0} .wrap{max-width:700px;margin:20px auto;padding:16px} .card{background:#0d131b;border:1px solid #223;border-radius:12px;padding:12px;margin-bottom:12px} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap} .btn{padding:10px 14px;border:1px solid #294760;border-radius:10px;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer} input,select{padding:10px;border-radius:10px;border:1px solid #223;background:#0e1520;color:#e6edf3}</style>
</head><body><div class="wrap">
<h1>QR Order - 주문</h1>
<div class="card">
  <div class="row">
    <label>테이블</label>
    <input id="tableNo" placeholder="예: 12" style="width:120px"/>
  </div>
  <div class="row" style="margin-top:8px">
    <label>오늘의 결제 코드</label>
    <input id="codeInput" placeholder="관리자에게 받은 4자리"/>
  </div>
</div>

<div class="card">
  <h3>메뉴</h3>
  <div id="menu"></div>
</div>

<div class="card">
  <div class="row">
    <div>합계: <b id="sum">0</b>원</div>
    <button class="btn" id="payBtn">결제하기</button>
  </div>
</div>

<script>
  const cart = new Map();
  let menuData = [];
  let clientKey = null;
  const fmt = (n)=> (n||0).toLocaleString('ko-KR');

  function setPayEnabled(enabled){
    const btn = document.getElementById('payBtn');
    btn.disabled = !enabled;
    btn.style.opacity = enabled ? '1' : '0.5';
    btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
  }
  function updateSum(){
    let sum = 0;
    for(const [id, qty] of cart){
      const m = menuData.find(x=> x.id===id);
      if(m) sum += (Number(m.price)||0) * (Number(qty)||0);
    }
    document.getElementById('sum').textContent = fmt(sum);
    setPayEnabled(sum>0 && cart.size>0);
    return sum;
  }
  function renderMenu(){
    const box = document.getElementById('menu');
    box.innerHTML = menuData.map(m=>`
      <div class="row" style="margin:6px 0">
        <div style="min-width:140px">${m.name}</div>
        <div style="min-width:80px">${fmt(m.price)}원</div>
        <button class="btn" onclick="addItem('${m.id}')">+</button>
        <span id="qty-${m.id}">${cart.get(m.id)||0}</span>
        <button class="btn" onclick="subItem('${m.id}')">-</button>
      </div>
    `).join('');
  }
  function addItem(id){ cart.set(id,(cart.get(id)||0)+1); const el=document.getElementById('qty-'+id); if(el) el.textContent=cart.get(id); updateSum(); }
  function subItem(id){ const v=(cart.get(id)||0)-1; if(v<=0) cart.delete(id); else cart.set(id,v); const el=document.getElementById('qty-'+id); if(el) el.textContent=cart.get(id)||0; updateSum(); }
  async function loadMenu(){ const r=await fetch('/menu'); menuData=await r.json(); renderMenu(); updateSum(); }
  async function loadClientKey(){ const r=await fetch('/config'); const j=await r.json(); clientKey=j.clientKey; }
  function getAmount(){ return Number(document.getElementById('sum').textContent.replace(/[^0-9]/g,''))||0; }
  function makeOrderId(){ return 'ORD-'+Math.random().toString(36).slice(2,10)+'-'+Date.now(); }

  async function requestPay(){
    const tableNo=(document.getElementById('tableNo').value||'').trim();
    const code=(document.getElementById('codeInput').value||'').trim();
    const amount=getAmount();
    if(!tableNo){ alert('테이블 번호를 입력하세요'); return; }
    if(cart.size===0 || amount<=0){ alert('메뉴를 담아 주세요'); return; }
    if(!code){ alert('오늘의 결제 코드를 입력하세요'); return; }
    try{
      const vr=await fetch('/verify-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
      if(!vr.ok){ const t=await vr.text(); alert('코드 확인 실패: '+t); return; }
    }catch(e){ alert('코드 확인 중 오류: '+(e?.message||e)); return; }
    if(!clientKey){ await loadClientKey(); }
    if(!window.TossPayments || !clientKey){ alert('결제 모듈 초기화 실패'); return; }
    const orderId=makeOrderId();
    const orderName='QR 주문';
    const origin=window.location.origin;
    const successUrl = `${origin}/payment/success`;
    const failUrl = `${origin}/payment/fail`;
    const items=Array.from(cart.entries()).map(([id,qty])=>[id,qty]);
    sessionStorage.setItem('qrOrderPending', JSON.stringify({ tableNo, items, amount, orderId }));
    try{
      const tossPayments=TossPayments(clientKey);
      await tossPayments.requestPayment('카드',{ amount, orderId, orderName, successUrl, failUrl });
    }catch(e){ alert('결제가 취소되었거나 창이 닫혔습니다.'); }
  }
  (function initTable(){ try{ const u=new URL(location.href); const t=u.searchParams.get('table'); if(t) document.getElementById('tableNo').value=t; }catch(_){} })();
  document.getElementById('payBtn').onclick=requestPay;
  setPayEnabled(false); loadClientKey(); loadMenu();
</script>
</div></body></html>
