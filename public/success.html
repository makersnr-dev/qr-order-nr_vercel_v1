<!doctype html><html lang="ko"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>주문 완료</title>
<style>
  :root{--bg:#0b0f14;--panel:#0d131b;--line:#223;--text:#e6edf3;--muted:#9fb0c3}
  body{font-family:system-ui;background:var(--bg);color:var(--text);min-height:100vh;margin:0}
  .hidden{display:none}
  .center{display:flex;align-items:center;justify-content:center;min-height:100vh}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6)}
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;max-width:520px;width:calc(100% - 32px);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .small{color:var(--muted)}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #294760;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer}
</style>
</head><body>
<div class="center"><div class="small" id="progress">결제 승인 확인 중...</div></div>
<div id="modalWrap" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-backdrop"></div>
  <div class="card">
    <h2 id="modalTitle" style="margin:4px 0 6px">주문이 완료되었습니다.</h2>
    <div id="modalDesc" class="small">결제가 확인되었어요. 잠시 후 주문 페이지로 돌아갑니다.</div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button id="okBtn" class="btn">확인</button>
    </div>
  </div>
</div>
<script>
(async () => {
  function qs(name){ return new URL(location.href).searchParams.get(name); }
  const paymentKey = qs('paymentKey'); 
  const orderId = qs('orderId'); 
  const amount = Number(qs('amount')||0);
  const progress = document.getElementById('progress'); 
  const modal = document.getElementById('modalWrap'); 
  const okBtn = document.getElementById('okBtn');
  
  function showModal(){ modal.classList.remove('hidden'); okBtn.focus(); }
  function closeAndGoHome(){ window.location.href = '/'; }
  okBtn.addEventListener('click', closeAndGoHome); 
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAndGoHome(); });
  modal.addEventListener('click', e=>{ if(e.target.classList.contains('modal-backdrop')) closeAndGoHome(); });
  
  try{
    // 1. 결제 승인 요청
    const cr = await fetch('/confirm', { 
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({ paymentKey, orderId, amount }) 
    });
    
    if(!cr.ok){ 
      const errorData = await cr.json().catch(() => ({}));
      progress.textContent = '결제 승인 실패: ' + (errorData.message || '알 수 없는 오류');
      console.error('Confirm failed:', errorData);
      return; 
    }

    // 2. 주문 정보 가져오기
    const saved = sessionStorage.getItem('qrOrderPending');
    if(!saved) {
      progress.textContent = '주문 정보를 찾을 수 없습니다.';
      return;
    }

    const pendingOrder = JSON.parse(saved);
    const { items, deliveryInfo, orderType } = pendingOrder;
    
    // 3. 주문 생성 요청 (배달 정보 포함)
    const orderPayload = {
      tableNo: orderType === 'delivery' ? '배달' : (pendingOrder.tableNo || ''),
      items,
      amount,
      paymentKey,
      orderId,
      deliveryInfo: deliveryInfo || null
    };

    const r = await fetch('/orders', { 
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(orderPayload)
    });
    
    if(!r.ok){ 
      console.warn('주문 생성 실패'); 
    }

    // 4. 세션 정리
    sessionStorage.removeItem('qrOrderPending'); 
    
    // 5. 장바구니 비우기
    try{ 
      localStorage.removeItem('qrCart'); 
    }catch(_){}

    // 6. 주문 이력 저장 (개선)
    try {
      const history = JSON.parse(localStorage.getItem('qrOrderHistory') || '[]');
      const historyItem = {
        time: Date.now(),
        items: items,
        amount: amount,
        orderId: orderId,
        orderType: orderType || 'store'
      };
      
      // 배달 주문인 경우 배달 정보 포함
      if (orderType === 'delivery' && deliveryInfo) {
        historyItem.addr = deliveryInfo.addr || '';
        historyItem.name = deliveryInfo.name || '';
        historyItem.phone = deliveryInfo.phone || '';
        historyItem.reserve = deliveryInfo.reserveTime || '';
        historyItem.note = deliveryInfo.note || '';
      }
      
      history.push(historyItem);
      
      // 최근 100개만 유지
      if (history.length > 100) {
        history.splice(0, history.length - 100);
      }
      localStorage.setItem('qrOrderHistory', JSON.stringify(history));
    } catch(e) {
      console.warn('History save failed:', e);
    }
    
    // 7. 성공 모달 표시
    progress.textContent=''; 
    showModal(); 
    setTimeout(closeAndGoHome, 3000);
    
  }catch(e){ 
    progress.textContent = '처리 중 오류: '+(e?.message||e); 
    console.error('Payment success handler error:', e);
  }
})();
</script>
</body></html>