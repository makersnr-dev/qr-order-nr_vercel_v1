<!DOCTYPE html>

<html lang="ko"><head><meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>QR Order - 배달/예약</title>
<script src="https://js.tosspayments.com/v1"></script>
<style>body{font-family:system-ui,Segoe UI,Noto Sans KR,sans-serif;background:#0b0f14;color:#e6edf3;margin:0} .wrap{max-width:700px;margin:20px auto;padding:16px} .card{background:#0d131b;border:1px solid #223;border-radius:12px;padding:12px;margin-bottom:12px} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap} .btn{padding:10px 14px;border:1px solid #294760;border-radius:10px;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer} input,select,textarea{padding:10px;border-radius:10px;border:1px solid #223;background:#0e1520;color:#e6edf3}
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.menu-card{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;width:100%;aspect-ratio:1/1;border-radius:12px;border:1px solid #223;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer;padding:8px}
.menu-card:hover{filter:brightness(1.06)}
.menu-title{font-weight:600;line-height:1.2;word-break:keep-all;overflow-wrap:anywhere}
.menu-price{margin-top:6px;opacity:.9;font-size:.9em}
.required{color:#f88}
.small{opacity:.8;font-size:14px}
.tabBtn{padding:8px 12px;border-radius:8px;border:1px solid #335;background:#0b1a2b;color:#e6edf3;cursor:pointer}
.tabBtn.active{background:#14324a}
.tabPane{display:none}
.tabPane.active{display:block}
.hint{margin-left:8px;opacity:.8;font-size:12px} .inline-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

.form-row{display:flex;align-items:center;gap:12px;margin:8px 0;flex-wrap:wrap}
.form-row label{width:110px;min-width:110px;text-align:left;opacity:.95}
.form-row input{flex:1}

/* 예약시간 라벨을 드롭다운 왼쪽에 두고, 화면이 좁아지면 라벨과 드롭다운을 함께 아래로 이동 */
.form-row.time-row{align-items:center}
.form-row.time-row .time-group{display:flex; gap:8px; flex-wrap:wrap; flex:1}
@media (max-width: 520px){
  .form-row.time-row{align-items:flex-start}
  .form-row.time-row label{width:100%; min-width:0; margin-bottom:6px}
  .form-row.time-row .time-group{width:100%}
}

.subTabBtn{background:#0b3050;color:#e6edf3;border:1px solid #234;padding:6px 10px;border-radius:8px;cursor:pointer}
.subTabBtn.active{background:#1976d2}
.hidden{display:none}
</style>
</head><body><div class="wrap">
<h1>배달/예약</h1>
<div class="row" style="margin:8px 0 12px;gap:14px">
  <label><input type="radio" name="orderMode" id="orderModeDelivery" checked> 배달(결제)</label>
  <label><input type="radio" name="orderMode" id="orderModeReserve"> 예약(무결제)</label>
</div>
<div id="reserveBankRow" class="row hidden" style="gap:10px">
  <button id="bankCopyBtn" class="btn" disabled>입금계좌 복사</button>
  <span id="bankCopyMsg" class="small"></span>
</div>

<div class="card" style="margin-bottom:10px">
<div id="tabs" style="display:flex;gap:8px">
<button class="tabBtn active" data-tab="order">주문</button>
<button class="tabBtn" data-tab="history">이전 주문</button>
</div>
</div>
<div class="tabPane active" id="orderPane">
<div class="card">
<h3>배달/예약 정보 <span class="required">*</span></h3>
<div class="row"><div class="form-row"><label for="addr">주소</label><input aria-label="배달 받을 주소" id="addr" placeholder="배송지 주소 *" required=""/></div></div>
<div class="row"><div class="form-row"><label for="name">주문자</label><input aria-label="주문자 성함" id="name" placeholder="주문자 이름 *" required=""/></div></div>
<div class="row"><div class="form-row"><label for="phone">연락처</label><input aria-label="연락용 번호(숫자만)" id="phone" inputmode="numeric" pattern="\d{8,13}" placeholder="연락처 (숫자만) *" required="" title="숫자만 8~13자리"/></div></div>
<div class="row">
<div class="form-row"><label for="date">예약일자</label><input aria-label="예약일자 (미입력 시 즉시주문)" id="date" inputmode="none" min="2025-10-31" onfocus="this.showPicker &amp;&amp; this.showPicker()" type="date"/></div>
<div class="form-row time-row"><label for="time">예약시간</label><div class="time-group" style="display:flex; gap:8px; flex-wrap:wrap; width:100%"><select aria-label="오전/오후" id="timePeriod" name="timePeriod" required=""><option disabled="" selected="" value="">오전/오후</option><option value="AM">오전</option><option value="PM">오후</option></select><select aria-label="시간(1~12)" id="timeHour" name="timeHour" required=""><option disabled="" selected="" value="">시</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option></select><select aria-label="분(5분)" id="timeMinute" name="timeMinute" required=""><option disabled="" selected="" value="">분</option><option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option></select></div></div>
</div>
<div class="row"><textarea id="note" placeholder="요청사항" style="width:100%;min-height:80px"></textarea></div>
</div>
<div class="card">
<h3>메뉴</h3>
<div class="menu-grid" id="menu"></div>
</div>
<div class="card">
<h3>장바구니 <span class="small" id="cartCountBadge"></span></h3>
<div id="cartList"></div>
</div>
<div class="card">
<div class="row">
<div>합계: <b id="sum">0</b>원</div>
<button class="btn" id="payBtn">결제하기</button>
</div>
</div>
</div>
<div class="tabPane" id="historyPane">
<div class="card">
<h3>이전 주문</h3>
<div id="history"></div>
<div class="small">이 브라우저에서 진행된 최근 주문을 표시합니다.</div>
</div>
</div>
<script>
(function() {
  'use strict';
  
  // ===== 전역 변수 =====
  const cart = loadCart();
  let menuData = [];
  let clientKey = null;
  const fmt = (n) => (n||0).toLocaleString('ko-KR');

  // ===== 유틸리티 함수 =====
let __bankInfo = null;
function showReserveUI(show){
  const row = document.getElementById('reserveBankRow');
  if(row){ row.classList.toggle('hidden', !show); }
  const btn = document.getElementById('bankCopyBtn'); if(btn){ btn.disabled = !show; }
}
async function fetchBankInfo(){

  try{
    const r = await fetch(joinUrl(ORDER_BASE || '', '/bank-info/public'));
    if(!r.ok) return;
    const j = await r.json();
    __bankInfo = (j && j.data) || null;
  }catch(_){ /* ignore */ }
}
function updatePayButton(){
  const payBtn = document.getElementById('payBtn');
  const isReserve = !!(document.getElementById('orderModeReserve') && document.getElementById('orderModeReserve').checked);
  if(payBtn){ payBtn.textContent = isReserve ? '예약하기' : '결제하기'; }
}
function copyBankInfo(){
  try{
    if(!__bankInfo){ return; }
    const text = [__bankInfo.bank||'', __bankInfo.account||'', __bankInfo.holder||''].filter(Boolean).join(' / ');
    navigator.clipboard.writeText(text).then(()=>{
      const m=document.getElementById('bankCopyMsg'); if(m){ m.textContent='복사되었습니다.'; setTimeout(()=>m.textContent='', 2000); }
    });
  }catch(_){ /* ignore */ }
}

  function getElement(id) {
    const el = document.getElementById(id);
    if (!el) {
      console.warn(`Element not found: ${id}`);
    }
    return el;
  }

  function getElementValue(id, defaultValue = '') {
    const el = getElement(id);
    return el ? (el.value || defaultValue).trim() : defaultValue;
  }
  function buildTimeFromSelects() {
    const period = getElementValue('timePeriod');
    const hourStr = getElementValue('timeHour');
    const minStr = getElementValue('timeMinute');
    if (!period || !hourStr || !minStr) return '';
    let h = parseInt(hourStr, 10);
    if (isNaN(h)) return '';
    if (period === 'AM') { if (h === 12) h = 0; }
    else if (period === 'PM') { if (h !== 12) h = h + 12; }
    const hh = ('0' + h).slice(-2);
    const mm = ('0' + parseInt(minStr,10)).slice(-2);
    return `${hh}:${mm}`;
  }


  // ===== 장바구니 관리 =====
  function loadCart() {
    try {
    // reserve toggles bound
    const mDel = document.getElementById('orderModeDelivery');
    const mRes = document.getElementById('orderModeReserve');
    const bankBtn = document.getElementById('bankCopyBtn');
    if(mDel && mRes){
      mDel.addEventListener('change',()=>{ if(mDel.checked){ showReserveUI(false); }});
      mRes.addEventListener('change',()=>{ if(mRes.checked){ showReserveUI(true); fetchBankInfo(); }});
    }
    if(bankBtn){ bankBtn.addEventListener('click', copyBankInfo); }

      const raw = localStorage.getItem('qrCart');
      if (!raw) return new Map();
      const arr = JSON.parse(raw);
      return new Map(arr.filter(([_,q]) => Number(q) > 0));
    } catch (e) {
      console.error('Cart load error:', e);
      return new Map();
    }
  }
  
  function saveCart() {
    try {
    // reserve toggles bound
    const mDel = document.getElementById('orderModeDelivery');
    const mRes = document.getElementById('orderModeReserve');
    const bankBtn = document.getElementById('bankCopyBtn');
    if(mDel && mRes){
      mDel.addEventListener('change',()=>{ if(mDel.checked){ showReserveUI(false); }});
      mRes.addEventListener('change',()=>{ if(mRes.checked){ showReserveUI(true); fetchBankInfo(); }});
    }
    if(bankBtn){ bankBtn.addEventListener('click', copyBankInfo); }

      const arr = Array.from(cart.entries()).filter(([_,q]) => Number(q) > 0);
      localStorage.setItem('qrCart', JSON.stringify(arr));
    } catch (e) {
      console.error('Cart save error:', e);
    }
  }

  function setPayEnabled(enabled) {
    const btn = getElement('payBtn');
    if (!btn) return;
    btn.disabled = !enabled;
    btn.style.opacity = enabled ? '1' : '0.5';
    btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
  }
  
  function updateSum() {
    let sum = 0;
    for (const [id, qty] of cart) {
      const m = menuData.find(x => x.id === id);
      if (m) sum += (Number(m.price)||0) * (Number(qty)||0);
    }
    const sumEl = getElement('sum');
    if (sumEl) sumEl.textContent = fmt(sum);
    setPayEnabled(sum > 0 && cart.size > 0);
    return sum;
  }
  
  function updateCartBadge() {
    const cnt = Array.from(cart.values()).reduce((a,b) => a + Number(b||0), 0);
    const el = getElement('cartCountBadge');
    if (el) {
      el.textContent = cnt ? `(${cnt}개 담김)` : '';
    }
  }
  
  function renderCart() {
    const box = getElement('cartList');
    if (!box) return;
    
    if (cart.size === 0) {
      box.innerHTML = '<div class="small">담긴 항목이 없습니다. 메뉴를 눌러 추가해주세요.</div>';
      updateCartBadge();
      return;
    }
    
    const rows = [];
    for (const [id, qty] of cart) {
      const m = menuData.find(x => x.id === id);
      if (!m) continue;
      const price = Number(m.price) || 0;
      const line = price * (Number(qty) || 0);
      rows.push(`
        <div class="row" style="margin:6px 0; justify-content: space-between;">
          <div style="min-width:140px">${m.name} <span class="small">x ${qty}</span></div>
          <div style="min-width:80px">${fmt(line)}원</div>
          <div class="row" style="gap:6px">
            <button class="btn" onclick="window.subItem('${m.id}')">-</button>
            <button class="btn" onclick="window.addItem('${m.id}')">+</button>
          </div>
        </div>
      `);
    }
    box.innerHTML = rows.join('');
    updateCartBadge();
  }

  function renderMenu() {
    const box = getElement('menu');
    if (!box) return;
    
    box.innerHTML = menuData.map(m => `
      <button class="menu-card" onclick="window.addItem('${m.id}')">
        <div class="menu-title">${m.name}</div>
        <div class="menu-price">${fmt(m.price)}원</div>
      </button>
    `).join('');
  }

  // ===== 장바구니 아이템 추가/삭제 (전역 노출) =====
  window.addItem = function(id) {
    cart.set(id, (cart.get(id) || 0) + 1);
    saveCart();
    renderMenu();
    renderCart();
    updateSum();
  };
  
  window.subItem = function(id) {
    const v = (cart.get(id) || 0) - 1;
    if (v <= 0) cart.delete(id);
    else cart.set(id, v);
    saveCart();
    renderMenu();
    renderCart();
    updateSum();
  };

  // ===== API 호출 =====
  async function loadMenu() {
    try {
    // reserve toggles bound
    const mDel = document.getElementById('orderModeDelivery');
    const mRes = document.getElementById('orderModeReserve');
    const bankBtn = document.getElementById('bankCopyBtn');
    if(mDel && mRes){
      mDel.addEventListener('change',()=>{ if(mDel.checked){ showReserveUI(false); }});
      mRes.addEventListener('change',()=>{ if(mRes.checked){ showReserveUI(true); fetchBankInfo(); }});
    }
    if(bankBtn){ bankBtn.addEventListener('click', copyBankInfo); }

      const r = await fetch('/menu');
      if (!r.ok) throw new Error('Menu fetch failed');
      menuData = await r.json();
      
      try {
    // reserve toggles bound
    const mDel = document.getElementById('orderModeDelivery');
    const mRes = document.getElementById('orderModeReserve');
    const bankBtn = document.getElementById('bankCopyBtn');
    if(mDel && mRes){
      mDel.addEventListener('change',()=>{ if(mDel.checked){ showReserveUI(false); }});
      mRes.addEventListener('change',()=>{ if(mRes.checked){ showReserveUI(true); fetchBankInfo(); }});
    }
    if(bankBtn){ bankBtn.addEventListener('click', copyBankInfo); }
 window.menuNameById = (menuData || []).reduce((acc,m)=>{ acc[m.id]=m.name; return acc; }, {}); } catch(_) { window.menuNameById = window.menuNameById || {}; }
renderMenu();
      updateSum();
    } catch (e) {
      console.error('메뉴 로드 실패:', e);
      alert('메뉴를 불러오는데 실패했습니다. 페이지를 새로고침해주세요.');
    }
  }
  
  async function loadClientKey() {
    try {
    // reserve toggles bound
    const mDel = document.getElementById('orderModeDelivery');
    const mRes = document.getElementById('orderModeReserve');
    const bankBtn = document.getElementById('bankCopyBtn');
    if(mDel && mRes){
      mDel.addEventListener('change',()=>{ if(mDel.checked){ showReserveUI(false); }});
      mRes.addEventListener('change',()=>{ if(mRes.checked){ showReserveUI(true); fetchBankInfo(); }});
    }
    if(bankBtn){ bankBtn.addEventListener('click', copyBankInfo); }

      const r = await fetch('/config');
      if (!r.ok) throw new Error('Config fetch failed');
      const j = await r.json();
      clientKey = j.clientKey;
    } catch (e) {
      console.error('클라이언트 키 로드 실패:', e);
    }
  }

  // ===== 배달 정보 수집 및 검증 =====
  function getDeliveryInfo() {
    // 안전하게 값 가져오기
    const addr = getElementValue('addr');
    const name = getElementValue('name');
    const phone = getElementValue('phone');
    const date = getElementValue('date');
    const time = buildTimeFromSelects();
    const note = getElementValue('note');

    // 필수 필드 검증
    if (!addr) {
      alert('배송지 주소를 입력해주세요.');
      const addrEl = getElement('addr');
      if (addrEl) addrEl.focus();
      return null;
    }
    
    if (!name) {
      alert('주문자 이름을 입력해주세요.');
      const nameEl = getElement('name');
      if (nameEl) nameEl.focus();
      return null;
    }
    
    if (!phone) {
      alert('연락처를 입력해주세요.');
      const phoneEl = getElement('phone');
      if (phoneEl) phoneEl.focus();
      return null;
    }

    // 전화번호 형식 검증
    const phoneClean = phone.replace(/[^0-9]/g, '');
    if (phoneClean.length < 10) {
      alert('올바른 연락처를 입력해주세요 (10자리 이상)');
      const phoneEl = getElement('phone');
      if (phoneEl) phoneEl.focus();
      return null;
    }

    // 예약 시간 조합
    let reserveTime = '';
    if (date && time) {
      reserveTime = `${date} ${time}`;
    } else if (date) {
      reserveTime = date;
    }

    return {
      addr,
      name,
      phone: phoneClean,
      reserveTime,
      note
    };
  }

  function getAmount() {
    const sumEl = getElement('sum');
    if (!sumEl) return 0;
    return Number(sumEl.textContent.replace(/[^0-9]/g, '')) || 0;
  }

  function makeOrderId() {
    return 'ORD-' + Math.random().toString(36).slice(2, 10) + '-' + Date.now();
  }

  // ===== 결제 요청 / 예약(무결제) 분기 =====
  async function requestPay() {
    const isReserve = !!(document.getElementById('orderModeReserve') && document.getElementById('orderModeReserve').checked);
    const amount = getAmount();
    
    // 장바구니 검증
    if (cart.size === 0 || amount <= 0) {
      alert('메뉴를 담아 주세요');
      return;
    }

    // 배달 정보 수집 및 검증
    const deliveryInfo = getDeliveryInfo();
    if (!deliveryInfo) {
      return; // 검증 실패
    }

    // 예약 분기: 결제 없이 주문 저장 및 완료 안내
    if(isReserve){
      const orderId = makeOrderId();
      const items = Array.from(cart.entries()).map(([id, qty]) => [id, qty]);
      try{
        sessionStorage.setItem('qrOrderPending', JSON.stringify({ items, amount, orderId, deliveryInfo, orderType: 'reserve', bankInfo: __bankInfo }));
      }catch(_){}
      try{
        const rr = await fetch('/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items, amount, orderId, deliveryInfo, orderType:'reserve', bankInfo: __bankInfo }) });
        if(rr.ok){ alert('예약이 접수되었습니다.'); window.location.href='/delivery/home'; return; }
      }catch(e){ alert('예약 처리 중 오류: '+(e?.message||e)); return; }
    }

    // 클라이언트 키 로드
    if (!clientKey) {
      await loadClientKey();
    }
    
    if (!window.TossPayments || !clientKey) {
      alert('결제 모듈 초기화 실패. 페이지를 새로고침해주세요.');
      return;
    }

    const orderId = makeOrderId();
    const orderName = '배달/예약 주문';
    const origin = window.location.origin;
    const successUrl = `${origin}/payment/success?from=delivery`;
    const failUrl = `${origin}/payment/fail?from=delivery`;
    const items = Array.from(cart.entries()).map(([id, qty]) => [id, qty]);

    // 주문 정보 저장
    try {
    // reserve toggles bound
    const mDel = document.getElementById('orderModeDelivery');
    const mRes = document.getElementById('orderModeReserve');
    const bankBtn = document.getElementById('bankCopyBtn');
    if(mDel && mRes){
      mDel.addEventListener('change',()=>{ if(mDel.checked){ showReserveUI(false); }});
      mRes.addEventListener('change',()=>{ if(mRes.checked){ showReserveUI(true); fetchBankInfo(); }});
    }
    if(bankBtn){ bankBtn.addEventListener('click', copyBankInfo); }

      sessionStorage.setItem('qrOrderPending', JSON.stringify({
        items,
        amount,
        orderId,
        deliveryInfo,
        orderType: 'delivery'
      }));
    } catch (e) {
      console.error('Session storage error:', e);
      alert('주문 정보 저장 실패. 다시 시도해주세요.');
      return;
    }

    // 예약(무결제) 분기
  if(isReserve){
    const orderId = makeOrderId();
    const items = Array.from(cart.entries()).map(([id, qty]) => [id, qty]);
    try{ sessionStorage.setItem('qrOrderPending', JSON.stringify({ items, amount, orderId, deliveryInfo, orderType: 'reserve', bankInfo: __bankInfo })); }catch(_){}
    try{
      const rr = await fetch('/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items, amount, orderId, deliveryInfo, orderType:'reserve', bankInfo: __bankInfo }) });
      if(rr.ok){ alert('예약이 접수되었습니다.'); window.location.href='/delivery/home'; return; }
      else{ alert('예약 접수 실패'); return; }
    }catch(e){ alert('네트워크 오류로 예약을 접수하지 못했습니다.'); return; }
  }
  // 결제 요청 // __reserveBranch
    try {
    // reserve toggles bound
    const mDel = document.getElementById('orderModeDelivery');
    const mRes = document.getElementById('orderModeReserve');
    const bankBtn = document.getElementById('bankCopyBtn');
    if(mDel && mRes){
      mDel.addEventListener('change',()=>{ if(mDel.checked){ showReserveUI(false); }});
      mRes.addEventListener('change',()=>{ if(mRes.checked){ showReserveUI(true); fetchBankInfo(); }});
    }
    if(bankBtn){ bankBtn.addEventListener('click', copyBankInfo); }

      const tossPayments = TossPayments(clientKey);
      await tossPayments.requestPayment('카드', {
        amount,
        orderId,
        orderName,
        successUrl,
        failUrl,
        customerName: deliveryInfo.name,
        customerMobilePhone: deliveryInfo.phone
      });
    } catch (e) {
      const code = e && (e.code || e.name);
      const ignorable = ['USER_CANCEL', 'PAY_PROCESS_CANCELED', 'POPUP_CLOSED'];
      
      if (ignorable.includes(code)) {
        // 사용자가 취소한 경우 조용히 처리
        return;
      }
      
      console.error('[TossPayments error]', e);
      const reason = encodeURIComponent(code || 'UNKNOWN');
      window.location.href = `/payment/fail?reason=${reason}`;
    }
  }

  // ===== 주문 이력 =====
  function renderHistoryInto(elId) {
    const box = getElement(elId);
    if (!box) return;
    
    try {
    // reserve toggles bound
    const mDel = document.getElementById('orderModeDelivery');
    const mRes = document.getElementById('orderModeReserve');
    const bankBtn = document.getElementById('bankCopyBtn');
    if(mDel && mRes){
      mDel.addEventListener('change',()=>{ if(mDel.checked){ showReserveUI(false); }});
      mRes.addEventListener('change',()=>{ if(mRes.checked){ showReserveUI(true); fetchBankInfo(); }});
    }
    if(bankBtn){ bankBtn.addEventListener('click', copyBankInfo); }

      const arr = JSON.parse(localStorage.getItem('qrOrderHistory') || '[]');
      
      if (!arr.length) {
        box.innerHTML = '<div class="small">표시할 내역이 없습니다.</div>';
        return;
      }
      
      box.innerHTML = arr.slice(-50).reverse().map(function(o) {
        const d = new Date(o.time || Date.now());
        const m = ('0' + (d.getMonth() + 1)).slice(-2);
        const dd = ('0' + d.getDate()).slice(-2);
        const hh = ('0' + d.getHours()).slice(-2);
        const mi = ('0' + d.getMinutes()).slice(-2);
        const items = (o.items || []).map(function(p) { const id=p[0]; const name=(window.menuNameById && window.menuNameById[id])||id; return name + '×' + p[1]; }).join(', ');
        const extra = [
          o.addr ? (' · ' + o.addr) : '',
          o.reserve ? (' · ' + o.reserve) : ''
        ].join('');
        const amt = o.amount || 0;
        
        return '<div style="padding:6px 0;border-bottom:1px solid #223">' +
          m + '/' + dd + ' ' + hh + ':' + mi + ' · ' + items + extra +
          (amt ? (' · 합계 ' + amt.toLocaleString('ko-KR') + '원') : '') +
          '</div>';
      }).join('');
    } catch (e) {
      console.error('History render error:', e);
      box.innerHTML = '<div class="small">이력을 불러올 수 없습니다.</div>';
    }
  }

  // ===== 탭 전환 =====
  function initTabs() {
    const tabs = document.querySelectorAll('.tabBtn');
    const orderPane = getElement('orderPane');
    const historyPane = getElement('historyPane');
    
    if (!tabs.length || !orderPane || !historyPane) {
      console.warn('Tab elements not found');
      return;
    }
    
    function activate(which) {
      tabs.forEach(function(b) {
        b.classList.toggle('active', b.dataset.tab === which);
      });
      
      orderPane.style.display = (which === 'order') ? 'block' : 'none';
      historyPane.style.display = (which === 'history') ? 'block' : 'none';
      
      if (which === 'history') {
        renderHistoryInto('history','all');
      }
    }
    
    activate('order');
  var subTabs=document.querySelectorAll('#historyFilterTabs .subTabBtn');
  window.__historyFilter='all';
  subTabs.forEach(function(b){ b.addEventListener('click', function(){
    subTabs.forEach(function(x){x.classList.toggle('active', x===b);});
    window.__historyFilter=b.dataset.filter;
    renderHistoryInto('history', window.__historyFilter);
  });});
    
    tabs.forEach(function(b) {
      b.addEventListener('click', function() {
        activate(b.dataset.tab);
      });
    });
  }

  // ===== 초기화 =====
  function init() {
    console.log('Initializing delivery page...');
    
    // 결제 버튼 연결
    const payBtn = getElement('payBtn');
    if (payBtn) {
      payBtn.onclick = requestPay;
    } else {
      console.error('Pay button not found!');
    }
    
    // 초기 상태 설정
    setPayEnabled(false);
    
    // 데이터 로드
    loadClientKey();
    loadMenu();
    renderCart();
    updateCartBadge();
    
    // 탭 초기화
    initTabs();
    
    console.log('Initialization complete');
  }

  // DOM 로드 완료 후 초기화
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>{ init(); try{ updatePayButton(); }catch(_){ } });
  } else {
    init();
  }
})();
</script>
</div></body></html>