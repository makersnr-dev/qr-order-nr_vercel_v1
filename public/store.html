<!doctype html><html lang="ko"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QR Order - 주문</title>
<script src="https://js.tosspayments.com/v1"></script>
<style>body{font-family:system-ui,Segoe UI,Noto Sans KR,sans-serif;background:#0b0f14;color:#e6edf3;margin:0} .wrap{max-width:700px;margin:20px auto;padding:16px} .card{background:#0d131b;border:1px solid #223;border-radius:12px;padding:12px;margin-bottom:12px} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap} .btn{padding:10px 14px;border:1px solid #294760;border-radius:10px;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer} input,select{padding:10px;border-radius:10px;border:1px solid #223;background:#0e1520;color:#e6edf3}
/* --- Responsive square grid for menu buttons --- */
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.menu-card{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;width:100%;aspect-ratio:1/1;border-radius:12px;border:1px solid #223;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer;padding:8px}
.menu-card:hover{filter:brightness(1.06)}
.menu-title{font-weight:600;line-height:1.2;word-break:keep-all;overflow-wrap:anywhere}
.menu-price{margin-top:6px;opacity:.9;font-size:.9em}
</style>
</head><body><div class="wrap">
<h1>QR Order - 주문</h1>
<div class="card">
  <div class="row">
    <label>테이블</label>
    <input id="tableNo" placeholder="예: 12" style="width:120px"/>
  </div>
  <div class="row" style="margin-top:8px">
    <label>오늘의 결제 코드</label>
    <input id="codeInput" placeholder="관리자에게 받은 4자리"/>
  </div>
</div>


<div class="card">
  <h3>직원 호출</h3>
  <div class="row">
    <label>호출 사유</label>
    <select id="callReason">
      <option value="">선택 없음</option>
      <option>물/음료 리필</option>
      <option>수저/냅킨 요청</option>
      <option>결제 요청</option>
      <option>기타 요청</option>
    </select>
    <button class="btn" id="callStaffBtn">직원 호출</button>
  </div>
  <div class="small" id="callMsg" style="margin-top:6px"></div>
</div>

<div class="card">
  <h3>메뉴</h3>
  <div id="menu"></div>
<div class="card">
  <h3>장바구니 <span id="cartCountBadge" class="small"></span></h3>
  <div id="cartList"></div>
</div>

</div>

<div class="card">
  <div class="row">
    <div>합계: <b id="sum">0</b>원</div>
    <button class="btn" id="payBtn">결제하기</button>
  </div>
</div>

<script>
  const cart = loadCart();
  let menuData = [];
  let clientKey = null;
  const fmt = (n)=> (n||0).toLocaleString('ko-KR');

  function setPayEnabled(enabled){
    const btn = document.getElementById('payBtn');
    btn.disabled = !enabled;
    btn.style.opacity = enabled ? '1' : '0.5';
    btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
  }
  function updateSum(){
    let sum = 0;
    for(const [id, qty] of cart){
      const m = menuData.find(x=> x.id===id);
      if(m) sum += (Number(m.price)||0) * (Number(qty)||0);
    }
    document.getElementById('sum').textContent = fmt(sum);
    setPayEnabled(sum>0 && cart.size>0);
    return sum;
  }
  
  // --- Cart Persistence & Rendering ---
  function loadCart() {
    try {
      const raw = localStorage.getItem('qrCart');
      if (!raw) return new Map();
      const arr = JSON.parse(raw);
      const m = new Map(arr.filter(([_,q]) => Number(q) > 0));
      return m;
    } catch (_) { return new Map(); }
  }
  function saveCart() {
    try {
      const arr = Array.from(cart.entries()).filter(([_,q]) => Number(q) > 0);
      localStorage.setItem('qrCart', JSON.stringify(arr));
    } catch (_) {}
  }
  function updateCartBadge(){
    const cnt = Array.from(cart.values()).reduce((a,b)=>a+Number(b||0),0);
    const el = document.getElementById('cartCountBadge');
    if (!el) return;
    el.textContent = cnt ? `(${cnt}개 담김)` : '';
  }
  function renderCart() {
    const box = document.getElementById('cartList');
    if (!box) return;
    if (cart.size === 0) {
      box.innerHTML = '<div class="small">담긴 항목이 없습니다 메뉴를 눌러 추가해주세요</div>';
      updateCartBadge();
      return;
    }
    const rows = [];
    for (const [id, qty] of cart) {
      const m = menuData.find(x=>x.id===id);
      if (!m) continue;
      const price = Number(m.price)||0;
      const line = price * (Number(qty)||0);
      rows.push(`
        <div class="row" style="margin:6px 0; justify-content: space-between;">
          <div style="min-width:140px">${m.name} <span class="small">x ${qty}</span></div>
          <div style="min-width:80px">${fmt(line)}원</div>
          <div class="row" style="gap:6px">
            <button class="btn" onclick="subItem('${m.id}')">-</button>
            <button class="btn" onclick="addItem('${m.id}')">+</button>
          </div>
        </div>
      `);
    }
    box.innerHTML = rows.join('');
    updateCartBadge();
  }



function renderMenu(){
  const box = document.getElementById('menu');
  box.classList.add('menu-grid');
  box.innerHTML = menuData.map(m=>`
    <button class="menu-card" onclick="addItem('${m.id}')">
      <div class="menu-title">${m.name}</div>
      <div class="menu-price">${fmt(m.price)}원</div>
    </button>
  `).join('');
}

  function addItem(id){ cart.set(id,(cart.get(id)||0)+1); saveCart(); renderMenu(); renderCart(); updateSum(); }
  function subItem(id){ const v=(cart.get(id)||0)-1; if(v<=0) cart.delete(id); else cart.set(id,v); saveCart(); renderMenu(); renderCart(); updateSum(); }
  async function loadMenu(){ const r=await fetch('/menu'); menuData=await r.json(); renderMenu(); updateSum(); }
  async function loadClientKey(){ const r=await fetch('/config'); const j=await r.json(); clientKey=j.clientKey; }
  function getAmount(){ return Number(document.getElementById('sum').textContent.replace(/[^0-9]/g,''))||0; }
  
  async function callStaff(){
    const tableNo=(document.getElementById('tableNo').value||'').trim();
    const reason=(document.getElementById('callReason').value||'').trim();
    const box=document.getElementById('callMsg');
    if(!tableNo){ box.textContent='테이블 번호를 먼저 입력해주세요.'; return; }
    try{
      const r=await fetch('/call-staff',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tableNo,reason})});
      if(r.ok){ box.textContent='호출되었습니다. 잠시만 기다려 주세요.'; setTimeout(()=>box.textContent='',4000); }
      else{ box.textContent='호출 실패. 잠시 후 다시 시도해주세요.'; }
    }catch(_){ box.textContent='네트워크 오류. 다시 시도해주세요.'; }
  }

  function makeOrderId(){
 return 'ORD-'+Math.random().toString(36).slice(2,10)+'-'+Date.now(); }

  async function requestPay(){
    const tableNo=(document.getElementById('tableNo').value||'').trim();
    const code=(document.getElementById('codeInput').value||'').trim();
    const amount=getAmount();
    if(!tableNo){ alert('테이블 번호를 입력하세요'); return; }
    if(cart.size===0 || amount<=0){ alert('메뉴를 담아 주세요'); return; }
    if(!code){ alert('오늘의 결제 코드를 입력하세요'); return; }
    try{
      const vr=await fetch('/verify-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
      if(!vr.ok){ const t=await vr.text(); alert('코드 확인 실패: '+t); return; }
    }catch(e){ alert('코드 확인 중 오류: '+(e?.message||e)); return; }
    if(!clientKey){ await loadClientKey(); }
    if(!window.TossPayments || !clientKey){ alert('결제 모듈 초기화 실패'); return; }
    const orderId=makeOrderId();
    const orderName='QR 주문';
    const origin=window.location.origin;
    const successUrl = `${origin}/payment/success`;
    const failUrl = `${origin}/payment/fail`;
    const items=Array.from(cart.entries()).map(([id,qty])=>[id,qty]);
    sessionStorage.setItem('qrOrderPending', JSON.stringify({ tableNo, items, amount, orderId }));
    try{
      const tossPayments=TossPayments(clientKey);
      await tossPayments.requestPayment('카드',{ amount, orderId, orderName, successUrl, failUrl });
    }catch(e){
      const code = e && (e.code || e.name);
      const ignorable = ['USER_CANCEL', 'PAY_PROCESS_CANCELED', 'POPUP_CLOSED'];
      if (ignorable.includes(code)) { /* 조용히 무시(취소) */ return; }
      console.error('[TossPayments error]', e);
      // 안내 모달 대신 실패 페이지로 이동 (alert 방지)
      const reason = encodeURIComponent(code || 'UNKNOWN');
      window.location.href = `/payment/fail?reason=${reason}`;
    }
  }
  (function initTable(){ try{ const u=new URL(location.href); const t=u.searchParams.get('table'); if(t) document.getElementById('tableNo').value=t; }catch(_){} })();
  document.getElementById('payBtn').onclick=requestPay;
  setPayEnabled(false); loadClientKey(); loadMenu();
  renderCart(); updateCartBadge();
  document.getElementById('callStaffBtn').onclick = callStaff;
</script>
<script>
function renderLocalHistory(){
  try{
    var box = document.getElementById('history');
    if(!box) return;
    var arr = JSON.parse(localStorage.getItem('qrOrderHistory')||'[]');
    if(!arr.length){ box.innerHTML='<div class="small">표시할 내역이 없습니다.</div>'; return; }
    box.innerHTML = arr.slice(-20).reverse().map(function(o){
      var d=new Date(o.time||Date.now());
      var m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
      var hh=('0'+d.getHours()).slice(-2), mi=('0'+d.getMinutes()).slice(-2);
      var items=(o.items||[]).map(function(p){ return p[0]+'×'+p[1]; }).join(', ');
      var amt=(o.amount||0).toLocaleString('ko-KR');
      return '<div style="padding:6px 0;border-bottom:1px solid #223">'+m+'/'+dd+' '+hh+':'+mi+' · '+items+' · 합계 '+amt+'원</div>';
    }).join('');
  }catch(e){}
}
try{ renderLocalHistory(); }catch(_){}
</script>
</div></body></html>
